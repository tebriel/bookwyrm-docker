From 458652d1688bc2568e23f6675dfd89d9673e4f80 Mon Sep 17 00:00:00 2001
From: Chris Moultrie <821688+tebriel@users.noreply.github.com>
Date: Thu, 5 Jan 2023 23:57:42 +0000
Subject: [PATCH] SSL for redis

---
 bookwyrm/management/commands/erase_streams.py | 1 +
 bookwyrm/redis_store.py                       | 1 +
 bookwyrm/settings.py                          | 1 +
 bookwyrm/views/admin/celery_status.py         | 1 +
 celerywyrm/settings.py                        | 1 +
 5 files changed, 5 insertions(+)

diff --git a/bookwyrm/management/commands/erase_streams.py b/bookwyrm/management/commands/erase_streams.py
index 9d971d699..47a1e56ef 100644
--- a/bookwyrm/management/commands/erase_streams.py
+++ b/bookwyrm/management/commands/erase_streams.py
@@ -9,6 +9,7 @@ r = redis.Redis(
     port=settings.REDIS_ACTIVITY_PORT,
     password=settings.REDIS_ACTIVITY_PASSWORD,
     db=settings.REDIS_ACTIVITY_DB_INDEX,
+    ssl=settings.REDIS_ACTIVITY_SSL,
 )
 
 
diff --git a/bookwyrm/redis_store.py b/bookwyrm/redis_store.py
index ae50db2ee..fb090a947 100644
--- a/bookwyrm/redis_store.py
+++ b/bookwyrm/redis_store.py
@@ -9,6 +9,7 @@ r = redis.Redis(
     port=settings.REDIS_ACTIVITY_PORT,
     password=settings.REDIS_ACTIVITY_PASSWORD,
     db=settings.REDIS_ACTIVITY_DB_INDEX,
+    ssl=settings.REDIS_ACTIVITY_SSL,
 )
 
 
diff --git a/bookwyrm/settings.py b/bookwyrm/settings.py
index fdc9a0483..7e20564c4 100644
--- a/bookwyrm/settings.py
+++ b/bookwyrm/settings.py
@@ -207,6 +207,7 @@ REDIS_ACTIVITY_HOST = env("REDIS_ACTIVITY_HOST", "localhost")
 REDIS_ACTIVITY_PORT = env("REDIS_ACTIVITY_PORT", 6379)
 REDIS_ACTIVITY_PASSWORD = env("REDIS_ACTIVITY_PASSWORD", None)
 REDIS_ACTIVITY_DB_INDEX = env("REDIS_ACTIVITY_DB_INDEX", 0)
+REDIS_ACTIVITY_SSL = env.bool("REDIS_ACTIVITY_SSL", False)
 
 MAX_STREAM_LENGTH = int(env("MAX_STREAM_LENGTH", 200))
 
diff --git a/bookwyrm/views/admin/celery_status.py b/bookwyrm/views/admin/celery_status.py
index 7da148a06..f99882679 100644
--- a/bookwyrm/views/admin/celery_status.py
+++ b/bookwyrm/views/admin/celery_status.py
@@ -13,6 +13,7 @@ r = redis.Redis(
     port=settings.REDIS_BROKER_PORT,
     password=settings.REDIS_BROKER_PASSWORD,
     db=settings.REDIS_BROKER_DB_INDEX,
+    ssl=settings.REDIS_BROKER_SSL,
 )
 
 # pylint: disable= no-self-use
diff --git a/celerywyrm/settings.py b/celerywyrm/settings.py
index 1a7732494..ab2755af0 100644
--- a/celerywyrm/settings.py
+++ b/celerywyrm/settings.py
@@ -8,6 +8,7 @@ REDIS_BROKER_PASSWORD = requests.utils.quote(env("REDIS_BROKER_PASSWORD", None))
 REDIS_BROKER_HOST = env("REDIS_BROKER_HOST", "redis_broker")
 REDIS_BROKER_PORT = env("REDIS_BROKER_PORT", 6379)
 REDIS_BROKER_DB_INDEX = env("REDIS_BROKER_DB_INDEX", 0)
+REDIS_BROKER_SSL = env.bool("REDIS_BROKER_SSL", False)
 
 CELERY_BROKER_URL = f"rediss://:{REDIS_BROKER_PASSWORD}@{REDIS_BROKER_HOST}:{REDIS_BROKER_PORT}/{REDIS_BROKER_DB_INDEX}?ssl_cert_reqs=required"
 CELERY_RESULT_BACKEND = f"rediss://:{REDIS_BROKER_PASSWORD}@{REDIS_BROKER_HOST}:{REDIS_BROKER_PORT}/{REDIS_BROKER_DB_INDEX}?ssl_cert_reqs=required"
-- 
2.25.1

